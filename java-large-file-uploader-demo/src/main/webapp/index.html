<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
<script src="./js/javalargefileuploader.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	
	//construct object
	jlfu = new JavaLargeFileUploader();
	
	//call the initializing function
	jlfu.initialize(
			true, //Yes I want first chunk of file validation
			function(pendingFiles) {
				
		//iterate over all the pending files
		for (key in pendingFiles) {
			var pendingFile = pendingFiles[key];

			//create a control element for each of them
			appendUploadControls(pendingFile.id);  					

			//if the file is complete
		  	if (pendingFile.fileComplete) {
		  		//specify it in the em element
		  		document.getElementById(pendingFile.id).children[0].textContent =
		  			"The file '"+pendingFile.originalFileName+"' has been fully uploaded ("+pendingFile.fileCompletion+"/"+pendingFile.originalFileSize+").";
		  	} 
			//else if incomplete and pending 
		  	else if (pendingFile.fileCompletion) {
		  		
		  		//describe the file so that the user can select it again
			  	document.getElementById(pendingFile.id).children[0].textContent =
			  		"The file '"+pendingFile.originalFileName+"' has been partially uploaded ("+pendingFile.fileCompletion+"/"+pendingFile.originalFileSize+"). Reselect it to continue uploading it or cancel it.";
			  		
		  		//set if there is a rate configured
			  	 document.getElementById(pendingFile.id).children[3].value = pendingFile.rateInKiloBytes;
		  		
		  	}
			
		}
		
	}, function(message) {
		alert(message);
	});
	
	//add a file upload element
	appendFileInputElement();	
 
});
function getFileId(element) {
	return element.parentElement.id;
}
function appendFileInputElement() {
	
	//get handle to main container
	var mainContainer = document.getElementById('fileContainer');
	
	//hide the last children
	if (mainContainer.children.length > 0) {
		mainContainer.children[mainContainer.children.length-1].hidden = true;
	}
	
	//generate a new file input control
    var fileInput = document.createElement("input"); 
    fileInput.type = "file";
    fileInput.setAttribute('multiple', 'multiple');
	mainContainer.appendChild(fileInput); 
	
    //add a listener
    fileInput.addEventListener("change", function(e) {
    	
    	//hide the fileupload and append a new one
    	appendFileInputElement();

  		//process the file upload
  		jlfu.fileUploadProcess(e.target, 
  			
  			//define a start callback to create the UI that will interact with the file upload
  			function(fileId, origin) {
				appendUploadControls(fileId);  					
  			},		
  				
  			//define a progressCallback to show the progress in the em elements 
			function(fileId, percentageCompleted, uploadRate, origin) {
 				document.getElementById(fileId).children[0].textContent = 
  					"Uploading... ("+percentageCompleted+"% complete) | Uploading at "+uploadRate + " per second.";
	  		}, 
  			
	  		//define a finishCallback showing the completion in the em element 
	  		function(theFileId, origin) {
	  			document.getElementById(fileId).children[0].textContent = "Upload completed.";
	  		}, 
	  		
	  		//define an exception callback
	  		function(message, origin, fileId /* file id can be null! if null, it is a general error */) {
	  			if (fileId) {
	  				document.getElementById(fileId).children[0].textContent = message;
	  			} else {
	  				document.getElementById("error").textContent = message;
	  			}
	  		}
  		);
  		
  	}, false);
    
}
function appendUploadControls(fileId) {
	
	//get the ui container
	var uiContainer = document.getElementById('uiContainer');
	
	//append a div
    var div = document.createElement("div"); 
    div.setAttribute('id', fileId);
    uiContainer.appendChild(div);
    
    ////
    //create the controls

    // rate input
    var rateInput = document.createElement("input"); 
    rateInput.type = "text";
    
    // rate button
   	var rateButton = document.createElement("button"); 
	rateButton.addEventListener("click", function(e) {
		jlfu.setRateInKiloBytes(getFileId(this), this.parentElement.children[2].value);
	});
   	rateButton.appendChild(document.createTextNode('Apply'));
	
	// cancel link
   	var cancel = document.createElement("A"); 
   	cancel.setAttribute("href","javascript:void(0);");
   	cancel.addEventListener("click", function(e) {
		div.children[0].textContent="Cancelling...";
		this.parentElement.parentElement.removeChild(this.parentElement);
		jlfu.cancelFileUpload(getFileId(this));
	});
   	cancel.appendChild(document.createTextNode('Cancel'));
	
	// pause link
   	var pause = document.createElement("A"); 
   	pause.setAttribute("href","javascript:void(0);");
   	pause.addEventListener("click", function(e) {
   		jlfu.pauseFileUpload(getFileId(this));
		div.children[0].textContent="Paused";
	});
   	pause.appendChild(document.createTextNode('Pause'));
	
	// resume link
   	var resume = document.createElement("A"); 
   	resume.setAttribute("href","javascript:void(0);");
   	resume.addEventListener("click", function(e) {
		jlfu.resumeFileUpload(getFileId(this));
		div.children[0].textContent="Resuming...";
	});
   	resume.appendChild(document.createTextNode('Resume'));

    
    ////
    //append the controls to the div
    div.appendChild(document.createElement("em"));
    div.appendChild(document.createElement("br"));
    div.appendChild(document.createTextNode('Limit the upload rate to '));
    div.appendChild(rateInput);
    div.appendChild(document.createTextNode(' KB '));
    div.appendChild(rateButton);
    div.appendChild(document.createElement("br"));
    div.appendChild(cancel);
    div.appendChild(document.createTextNode(' | '));
    div.appendChild(pause);
    div.appendChild(document.createTextNode(' | '));
    div.appendChild(resume);
	
}

</script>
</head>
<body>
	
	<div id="fileContainer">
	</div>

	<hr>

	<div id="uiContainer">
	</div>

	<hr>

	<div>
		<a href='javascript:void(0)' onclick='jlfu.clearFileUpload(function(e) {window.location.reload();});'>Clear all</a>
	</div>
	
	<em id="error"></em>
	
</body>
</html>